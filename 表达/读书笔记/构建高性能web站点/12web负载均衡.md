# 负载均衡
负载均衡怎么理解？
不能狭义的理解为分配给所有实际服务器的工作量一样多，因为有时候，多台服务器的承载能力各不相同，这可能体现在硬件配置、网络带宽的差异，也可能因为某台服务器身兼多职，我们所说的“均衡”，也就是希望所有服务器都不要过载，并且能够最大程度地发挥作用。
* 单点故障：通常分布式系统采用主从模式，一个主机连接多个处理节点，主节点负责分发任务，而子节点负责处理业务，当主节点发生故障时，会导致整个系统发故障，我们把这种故障叫做单点故障。
* 高可用性（HA）:指的是通过尽量缩短因日常维护操作（计划）和突发的系统崩溃（非计划）所导致的停机时间，以提高系统和应用的可用性。
* 
## HTTP重定向
HTTP重定向具备了请求转移和自动跳转的本领，可以用于实现负载均衡，以达到web扩展的目的。重定向由HTTP代理和web服务器共同实现。
可以在代码配置跳转的location，采用随机选取配置的location进行跳转。
为什么不用轮询的重定向策略：1）HTTP本是无状态的，要实现按顺序转移请求，势必要将最后一次转移到的服务器编号进行保存，这将会带来一定开销；2）要实现顺序转移，就会要记录转移状态，而转移状态是一个互斥资源，转发程序必须要通过一定的锁机制来保障只有一个请求可以修改它，这将会影响请求转移计算的并发性。

## DNS负载均衡

当访问站点时，首先需要该站点域名的DNS服务器获取域名对应的ip地址，DNS服务器完成了域名到ip的映射，可以是一对多的，这个时候DNS服务器充当了负载均衡调度器的角色。

DNS服务软件通常提供丰富的调度策略供你选择，其中最常用的就是根据用户IP来进行智能解析，可以再所有可用的A记录中寻找里用户最近的一台服务器。

故障转移：当一台服务器出现故障时，如何自动监测到故障并第一时间修改DNS记录，且修改后能够及时生效。动态DNS可以实现，每次IP地址变更时可以及时地更新DNS服务器。

## 反向代理负载均衡
反向代理负载均衡器，对于HTTP请求的调度体现在转发上，前面所说的两种是转移。这意味着：
* 任何对于实际服务器的HTTP请求都必须经过调度器
* 调度器必须等待实际服务器的HTTP响应，并将它反馈给用户。

反向代理服务器对于所有HTTP请求都需要亲自转发，当后端服务器处理时间较少时，反向代理服务器转发的开销成为影响性能的瓶颈，所以当反向代理服务器的吞吐率接近极限时，再添加后端服务器都是无济于事的。对于这种情况，基于DNS的负载均衡方式会更合适。

**健康监测**：反向代理服务器可以监控后端服务器的很多方面，比如系统负载、响应时间、是否可用、TCP连接数、流量等，它们都是负载均衡调度策略需要考虑的因素。

Nginx 反向代理模块：ngx_http_proxy_module、ngx_http_upstream_module 后端检测模块：nginx_http_upstream_check_module

有了健康监测，在出现错误的时候，调度器会放弃已关闭服务的后端服务器，且可以部署一定数量的备用后端服务器，当某些后端服务器出错时备用机器可以接替，保障整体的性能。

**黏滞会话：**
背景：当负载均衡采用RR（轮询调度算法）调度策略时，即使是同一用户对同一内容的多次请求，可能被转发到了不同的后端服务器，可能会带来一些问题，例如：
* 后端服务器启用了session来本地化保护用户的一些数据，下次用户请求如果转发给了其他服务器就会丢失这些session数据，导致无法访问；
* 后端服务器实现的动态缓存内容，在这种无规律的转发使得这些缓存的利用率下降。
问题1：RR调度策略为什么会使毫无规律的转发？不是按顺序轮流来的吗
如何解决:让用户在一次会话周期内的所有请求始终转发到一台特定的后端服务器上，这种机制也称为黏滞会话。
1）可以通过ip地址作为识别标志，对用户ip进行hash计算三列到不同的后端服务器上。
2）可以吧后端服务器编号通过调度器追加到用户的cookies中去。
规避这种情况：使用黏滞会话多少会破坏均衡策略，所以要尽可能避免在后端服务器保存session数据和本地化缓存，采用分布式session或分布式缓存等设计来代替。

## ip负载均衡
